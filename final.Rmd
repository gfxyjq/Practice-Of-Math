---
title: "Final"
author: "3230104912 Zhai Guoqing"
date: \today
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
    
---

```{r setup, message = F, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(DAAG)
```

# 1.find the inverse of the given matrix and verify it:
```{r}
A <- matrix(c(9, 4, 12, 2,
              5, 0, 7, 9,
              2, 6, 8, 0,
              9, 2, 9, 11), 
            nrow = 4, byrow = TRUE)
A_inv <- solve(A)
identity_matrix <- diag(4)
product <- A %*% A_inv

verification <- all.equal(product, identity_matrix)

print(A)
print(A_inv)
print(verification)
```

# 2.
```{r}
xVec <- sample(0:999, 250, replace=T)
yVec <- sample(0:999, 250, replace=T)
```

## a.Create the vector (y2 − x1, · · · , yn − xn−1)
```{r}
a_result <- yVec[-1] - xVec[-length(xVec)]
```

## b.Pick out the values in yVec which are > 600
```{r}
b_result <- yVec[yVec > 600]
```

## c.What are the index positions in yVec of the values which are > 600?
```{r}
c_result <- which(yVec > 600)
```

## d.Sort the numbers in the vector xVec in the order of increasing values in yVec
```{r}
d_result <- xVec[order(yVec)]
```

## e.Pick out the elements in yVec at index positions 1, 4, 7, 10, 13, ...
```{r}
e_result <- yVec[seq(1, 250, by = 3)]
```

# 3.
```{r}
library(tibble)
library(dplyr)
data(state)
state.x77 <- as_tibble(state.x77, rownames = 'State')
```

## a.Select states with income < 4300 and calculate their average income
```{r}
a_result <- state.x77 |>
  filter(Income < 4300) |>
  summarise(avg_income = mean(Income))

print(a_result)
```

## b.Sort by income and select the state with highest income
```{r}
b_result <- state.x77 |>
  arrange(desc(Income)) |>
  slice(1)

print(b_result)
```

## c.Add population size category variable
```{r}
state.x77 <- state.x77 |>
  mutate(pop_size = ifelse(Population <= 4500, "S", "L"))

print(head(state.x77))
```

## d.Average income and illiteracy by population size group
```{r}
d_result <- state.x77 |>
  group_by(pop_size) |>
  summarise(
    avg_income = mean(Income),
    avg_illiteracy = mean(Illiteracy)
  )

print(d_result)
```

# 4.
## a.Simulate n observations of (X1, X2)
```{r}
f1 <- function(n) {
  data.frame(
    X1 = runif(n),
    X2 = runif(n)
  )
}
```

## b.Calculate the proportion of the observations
```{r}
f2 <- function(data) {
  # Calculate distance to nearest edge
  dist_to_edge <- pmin(data$X1, data$X2, 1 - data$X1, 1 - data$X2)
  
  # Calculate distance to nearest vertex (0,0), (0,1), (1,0), (1,1)
  dist_to_vertex <- sqrt(pmin(
    (data$X1)^2 + (data$X2)^2,
    (data$X1)^2 + (1 - data$X2)^2,
    (1 - data$X1)^2 + (data$X2)^2,
    (1 - data$X1)^2 + (1 - data$X2)^2
  ))
  
  prop_edge_lt_0.25 <- mean(dist_to_edge < 0.25)
  prop_vertex_lt_0.25 <- mean(dist_to_vertex < 0.25)
  
  list(
    prop_edge_lt_0.25 = prop_edge_lt_0.25,
    prop_vertex_lt_0.25 = prop_vertex_lt_0.25
  )
}

set.seed(123)
sim_data <- f1(10000)
results <- f2(sim_data)
cat("Proportion with distance to nearest edge < 0.25:", results$prop_edge_lt_0.25, "\n")
cat("Proportion with distance to nearest vertex < 0.25:", results$prop_vertex_lt_0.25, "\n")
```

# 5.Monte Carlo simulation
## a.Show the estimation of pi at each row
```{r}
n <- 10000  
set.seed(1)  
points <- tibble("x" = runif(n), "y" = runif(n))  

points <- points |>
mutate(inside = map2_dbl(.x = x, .y = y, ~ifelse(.x**2 + .y**2 < 1, 1, 0))) |>
rowid_to_column("N")

points <- points |>
  mutate(
    cumulative_inside = cumsum(inside),
    pi_estimate = 4 * cumulative_inside / N
  )

head(points, 10)
tail(points, 10)
```

## b.Plot the estimates of pi against N
```{r}
ggplot(points, aes(x = N, y = pi_estimate)) +
  geom_line() +
  geom_hline(yintercept = pi, color = "red", linetype = "dashed") +
  labs(title = "Monte Carlo Estimation of pi",
       subtitle = paste("Final estimate after", n, "samples:", round(points$pi_estimate[n], 6)),
       x = "Number of samples (N)",
       y = "Estimate of pi") +
  theme_minimal() +
  ylim(3, 3.3)
```

# 6.
```{r}
suicrates <- tibble(Country = c('Canada', 'Israel', 'Japan', 'Austria', 'France', 'Germany',
'Hungary', 'Italy', 'Netherlands', 'Poland', 'Spain', 'Sweden', 'Switzerland', 'UK', 'USA'),
Age25.34 = c(22, 9, 22, 29, 16, 28, 48, 7, 8, 26, 4, 28, 22, 10, 20),
Age35.44 = c(27, 19, 19, 40, 25, 35, 65, 8, 11, 29, 7, 41, 34, 13, 22),
Age45.54 = c(31, 10, 21, 52, 36, 41, 84, 11, 18, 36, 10, 46, 41, 15, 28),
Age55.64 = c(34, 14, 31, 53, 47, 49, 81, 18, 20, 32, 16, 51, 50, 17, 33),
Age65.74 = c(24, 27, 49, 69, 56, 52, 107, 27, 28, 28, 22, 35, 51, 22, 37))
```

## a.Transform suicrates into long form
```{r}
suicrates_long <- suicrates |>
  pivot_longer(
    cols = starts_with("Age"),
    names_to = "Age_Group",
    values_to = "Mortality_Rate"
  ) |>
  mutate(
    Age_Group = factor(Age_Group, 
                      levels = c("Age25.34", "Age35.44", "Age45.54", 
                                "Age55.64", "Age65.74"),
                      labels = c("25-34", "35-44", "45-54", "55-64", "65-74"))
  )

head(suicrates_long)
```

## b.Construct side-by-side box plots and comment
```{r}
ggplot(suicrates_long, aes(x = Age_Group, y = Mortality_Rate, fill = Age_Group)) +
  geom_boxplot() +
  labs(title = "Suicide Mortality Rates by Age Group Across Countries",
       subtitle = "Per 100,000 males",
       x = "Age Group",
       y = "Mortality Rate",
       fill = "Age Group") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Pastel1")
```

Comment:Mortality rates show a consistent upward trend with increasing age, reaching their highest levels in the 65-74 age group. The most pronounced increase occurs between the 25-34 and 35-44 age categories. 

The most striking disparity appears in the 65-74 age bracket, where Hungary's rate of 107  contrasts sharply with Spain's 22. This fivefold difference underscores significant international variations in elderly mental health outcomes. The findings suggest that while aging universally increases suicide risk, national-level factors play a substantial moderating role, indicating opportunities for cross-country learning and policy intervention, particularly regarding elderly mental health support systems.

# 7.
```{r}
# data(LaborSupply)
LaborSupply <- read_csv("LaborSupply.csv")
# create hour and wage variables
labor <- LaborSupply |>
mutate(hour = exp(lnhr), wage = exp(lnwg), .before = kids) |>
dplyr::select(-lnhr, -lnwg)
```

## a.Average annual hours worked and SD by year
```{r}
labor |>
  group_by(year) |>
  summarise(avg_hours = mean(hour),
            sd_hours = sd(hour))
```

## b.Age group with most hours in 1982
```{r}
labor |>
  filter(year == 1982) |>
  mutate(age_group = cut(age, breaks = seq(20, 70, by = 10))) |>
  group_by(age_group) |>
  summarise(avg_hours = mean(hour)) |>
  arrange(desc(avg_hours)) |>
  slice(1)
```

## c.Panel balance check
```{r}
panel_check <- labor |>
  group_by(id) |>
  summarise(n_years = n_distinct(year)) 

is_balanced <- all(panel_check$n_years == max(panel_check$n_years))
cat("Is the panel balanced?", is_balanced, "\n")
```

## d.Identify individuals with no kids
```{r}
labor <- labor |>
  group_by(id) |>
  mutate(no_kids = as.integer(all(kids == 0))) |>
  ungroup()
```

## e.Wage statistics by no_kids in 1980
```{r}
labor |>
  filter(year == 1980) |>
  group_by(no_kids) |>
  summarise(avg_wage = mean(wage),
            sd_wage = sd(wage),
            n_obs = n())
```